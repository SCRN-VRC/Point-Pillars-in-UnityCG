#ifndef __POINT_PILLARS__
#define __POINT_PILLARS__

static const uint4 weightsPos[106] =
{
    2432, 1536, 9, 64,       // const0
    2816, 1617, 64, 1,       // const1
    2816, 1618, 64, 1,       // const2
    2304, 1472, 576, 64,       // const3
    2816, 1627, 64, 1,       // const4
    2816, 1626, 64, 1,       // const5
    2304, 1280, 576, 64,       // const6
    2816, 1625, 64, 1,       // const7
    2816, 1624, 64, 1,       // const8
    2304, 1408, 576, 64,       // const9
    2816, 1623, 64, 1,       // const10
    2816, 1622, 64, 1,       // const11
    2304, 1344, 576, 64,       // const12
    2816, 1621, 64, 1,       // const13
    2816, 1620, 64, 1,       // const14
    2304, 1024, 576, 128,       // const15
    2304, 1624, 128, 1,       // const16
    2688, 1623, 128, 1,       // const17
    1152, 1408, 1152, 128,       // const18
    2560, 1623, 128, 1,       // const19
    2432, 1623, 128, 1,       // const20
    0, 1664, 1152, 128,       // const21
    2560, 1622, 128, 1,       // const22
    2688, 1621, 128, 1,       // const23
    1152, 1280, 1152, 128,       // const24
    2304, 1621, 128, 1,       // const25
    2688, 1620, 128, 1,       // const26
    1152, 1536, 1152, 128,       // const27
    2560, 1620, 128, 1,       // const28
    2432, 1620, 128, 1,       // const29
    0, 1536, 1152, 128,       // const30
    2304, 1620, 128, 1,       // const31
    2560, 1625, 128, 1,       // const32
    0, 1280, 1152, 256,       // const33
    2560, 1613, 256, 1,       // const34
    2304, 1614, 256, 1,       // const35
    1152, 0, 576, 1024,       // const36
    2304, 1615, 256, 1,       // const37
    2560, 1615, 256, 1,       // const38
    576, 0, 576, 1024,       // const39
    2560, 1616, 256, 1,       // const40
    2304, 1617, 256, 1,       // const41
    0, 0, 576, 1024,       // const42
    2304, 1618, 256, 1,       // const43
    2560, 1618, 256, 1,       // const44
    2304, 0, 576, 1024,       // const45
    2560, 1612, 256, 1,       // const46
    2304, 1612, 256, 1,       // const47
    1728, 0, 576, 1024,       // const48
    2560, 1610, 256, 1,       // const49
    2304, 1609, 256, 1,       // const50
    2304, 1536, 128, 64,       // const51
    2432, 1621, 128, 1,       // const52
    2560, 1621, 128, 1,       // const53
    2304, 1152, 512, 128,       // const54
    2304, 1622, 128, 1,       // const55
    2432, 1622, 128, 1,       // const56
    0, 1024, 2048, 256,       // const57
    2688, 1622, 128, 1,       // const58
    2304, 1623, 128, 1,       // const59
    2441, 1578, 384, 18,       // const60
    2858, 1628, 18, 1,       // const61
    2441, 1536, 384, 42,       // const62
    2816, 1628, 42, 1,       // const63
    2441, 1596, 384, 12,       // const64
    2304, 1629, 12, 1,       // const65
    2816, 1616, 64, 1,       // rm0
    2816, 1615, 64, 1,       // rv0
    2816, 1614, 64, 1,       // rm1
    2816, 1613, 64, 1,       // rv1
    2816, 1612, 64, 1,       // rm2
    2816, 1611, 64, 1,       // rv2
    2816, 1610, 64, 1,       // rm3
    2816, 1609, 64, 1,       // rv3
    2816, 1608, 64, 1,       // rm4
    2816, 1619, 64, 1,       // rv4
    2432, 1627, 128, 1,       // rm5
    2560, 1627, 128, 1,       // rv5
    2688, 1627, 128, 1,       // rm6
    2304, 1628, 128, 1,       // rv6
    2432, 1628, 128, 1,       // rm7
    2560, 1628, 128, 1,       // rv7
    2304, 1627, 128, 1,       // rm8
    2688, 1626, 128, 1,       // rv8
    2560, 1626, 128, 1,       // rm9
    2432, 1626, 128, 1,       // rv9
    2304, 1626, 128, 1,       // rm10
    2688, 1625, 128, 1,       // rv10
    2560, 1619, 256, 1,       // rm11
    2560, 1617, 256, 1,       // rv11
    2304, 1616, 256, 1,       // rm12
    2304, 1613, 256, 1,       // rv12
    2560, 1611, 256, 1,       // rm13
    2560, 1608, 256, 1,       // rv13
    2560, 1614, 256, 1,       // rm14
    2304, 1619, 256, 1,       // rv14
    2304, 1611, 256, 1,       // rm15
    2304, 1610, 256, 1,       // rv15
    2560, 1609, 256, 1,       // rm16
    2304, 1608, 256, 1,       // rv16
    2432, 1624, 128, 1,       // rm17
    2560, 1624, 128, 1,       // rv17
    2688, 1624, 128, 1,       // rm18
    2304, 1625, 128, 1,       // rv18
    2432, 1625, 128, 1,       // rm19
    2688, 1628, 128, 1,       // rv19
};

static const uint4 layerPos1[16] = 
{
    0, 4096, 2048, 512,       // l1
    2048, 4096, 1536, 512,       // l3
    4096, 4096, 512, 512,       // l4
    3584, 4096, 512, 512,       // l5
    4608, 4096, 128, 128,       // compress
    0, 0, 8192, 4096,       // l6
    0, 4608, 8192, 128,       // l7
    3968, 4736, 1984, 3456,       // l25
    0, 4736, 1984, 3456,       // l26
    1984, 4736, 1984, 3456,       // l27
    7440, 4736, 744, 1296,       // l28
    5952, 4736, 1488, 1512,       // l29
    7440, 6032, 744, 864,       // l30
    5952, 7760, 1736, 432,       // l31
    5952, 6896, 1736, 432,       // l32
    5952, 7328, 1736, 432,       // l33
};

static const uint4 layerPos2[17] =
{
    0, 0, 3968, 3456,       // l8
    1984, 3456, 1984, 1728,       // l9
    3968, 0, 1984, 1728,       // l10
    3968, 1728, 1984, 1728,       // l11
    0, 3456, 1984, 1728,       // l12
    3968, 3456, 1984, 864,       // l13
    3968, 4320, 1984, 864,       // l14
    0, 5184, 1984, 864,       // l15
    1984, 5184, 1984, 864,       // l16
    3968, 5184, 1984, 864,       // l17
    0, 6048, 1984, 864,       // l18
    5952, 4320, 992, 864,       // l19
    5952, 0, 992, 864,       // l20
    5952, 864, 992, 864,       // l21
    5952, 1728, 992, 864,       // l22
    5952, 2592, 992, 864,       // l23
    5952, 3456, 992, 864,       // l24
};

/*
    Unrolled bitonic merge sort loop for a 512x512 texture
*/

static const uint flipArray[189] =
{
    2, 2, 4, 4, 4, 8, 8, 8, 8, 
    16, 16, 16, 16, 16, 32, 32, 32, 32, 
    32, 32, 64, 64, 64, 64, 64, 64, 64, 
    128, 128, 128, 128, 128, 128, 128, 128, 256, 
    256, 256, 256, 256, 256, 256, 256, 256, 512, 
    512, 512, 512, 512, 512, 512, 512, 512, 512, 
    1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 
    1024, 1024, 2048, 2048, 2048, 2048, 2048, 2048, 2048, 
    2048, 2048, 2048, 2048, 2048, 4096, 4096, 4096, 4096, 
    4096, 4096, 4096, 4096, 4096, 4096, 4096, 4096, 4096, 
    8192, 8192, 8192, 8192, 8192, 8192, 8192, 8192, 8192, 
    8192, 8192, 8192, 8192, 8192, 16384, 16384, 16384, 16384, 
    16384, 16384, 16384, 16384, 16384, 16384, 16384, 16384, 16384, 
    16384, 16384, 32768, 32768, 32768, 32768, 32768, 32768, 32768, 
    32768, 32768, 32768, 32768, 32768, 32768, 32768, 32768, 32768, 
    65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 
    65536, 65536, 65536, 65536, 65536, 65536, 65536, 65536, 131072, 
    131072, 131072, 131072, 131072, 131072, 131072, 131072, 131072, 131072, 
    131072, 131072, 131072, 131072, 131072, 131072, 131072, 131072, 262144, 
    262144, 262144, 262144, 262144, 262144, 262144, 262144, 262144, 262144, 
    262144, 262144, 262144, 262144, 262144, 262144, 262144, 262144, 262144
};

static const uint disperseArray[189] =
{
    1, 0, 2, 1, 0, 4, 2, 1, 0, 
    8, 4, 2, 1, 0, 16, 8, 4, 2, 
    1, 0, 32, 16, 8, 4, 2, 1, 0, 
    64, 32, 16, 8, 4, 2, 1, 0, 128, 
    64, 32, 16, 8, 4, 2, 1, 0, 256, 
    128, 64, 32, 16, 8, 4, 2, 1, 0, 
    512, 256, 128, 64, 32, 16, 8, 4, 2, 
    1, 0, 1024, 512, 256, 128, 64, 32, 16, 
    8, 4, 2, 1, 0, 2048, 1024, 512, 256, 
    128, 64, 32, 16, 8, 4, 2, 1, 0, 
    4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 
    8, 4, 2, 1, 0, 8192, 4096, 2048, 1024, 
    512, 256, 128, 64, 32, 16, 8, 4, 2, 
    1, 0, 16384, 8192, 4096, 2048, 1024, 512, 256, 
    128, 64, 32, 16, 8, 4, 2, 1, 0, 
    32768, 16384, 8192, 4096, 2048, 1024, 512, 256, 128, 
    64, 32, 16, 8, 4, 2, 1, 0, 65536, 
    32768, 16384, 8192, 4096, 2048, 1024, 512, 256, 128, 
    64, 32, 16, 8, 4, 2, 1, 0, 131072, 
    65536, 32768, 16384, 8192, 4096, 2048, 1024, 512, 256, 
    128, 64, 32, 16, 8, 4, 2, 1, 0
};

static const uint primes[31] =
{
    2, 3, 5, 7, 11, 13, 17, 19, 23, 29,
    31, 37, 41, 43, 47, 53, 59, 61, 67, 71,
    73, 79, 83, 89, 97, 101, 103, 107, 109, 113,
    127
};

static const float coors_range[6] =
    { 0.0f, -39.68f, -3.0f, 69.12f, 39.68f, 1.0f };
static const float voxel_size[3] = { 0.16f, 0.16f, 4.0f };

#define mod(x,y) ((x)-(y)*floor((x)/(y))) // glsl mod
#define sc_uint2 static const uint2

#define MAX_FLOAT                               1e6
#define MAX_LOOP                                21
#define MAX_POINTS                              32
#define MAX_LAYERS                              30

#define txSortInputLoop                         uint2(0, 0)
#define txLayerCounter0                         uint2(1, 0)
#define txLayerCounter1                         uint2(2, 0)
#define txLayerThread                           uint2(3, 0)
#define txLayerHash                             uint2(4, 0)

inline bool insideArea(in uint4 area, uint2 px)
{
    if (px.x >= area.x && px.x < (area.x + area.z) &&
        px.y >= area.y && px.y < (area.y + area.w))
    {
        return true;
    }
    return false;
}

void StoreValue(in uint2 txPos, in float value, inout float col,
    in uint2 fragPos)
{
    col = all(fragPos == txPos) ? value : col;
}

float sigmoid(float x)
{
    return 1.0f / (1.0 + exp(-x));
}

float relu(float x)
{
    return x < 0.0 ? 0.0 : x;
}

float batchNorm(float x, float gamma, float beta, float mean, float var)
{
    return ((x - mean) / sqrt(var + 0.001)) * gamma + beta;
}

float getLayer1(Texture2D<float> tex, uint layer, uint4 off, uint3 input)
{
    uint2 pos;
    pos.x = input.x + (input.z % off.x) * off.z;
    pos.y = input.y + (input.z / off.y) * off.w;
    return tex[layerPos1[layer] + pos];
}

float getLayer2(Texture2D<float> tex, uint layer, uint4 off, uint3 input)
{
    uint2 pos;
    pos.x = input.x + (input.z % off.x) * off.z;
    pos.y = input.y + (input.z / off.y) * off.w;
    return tex[layerPos2[layer] + pos];
}

float padLayerUneven(Texture2D<float> tex, uint layer, uint4 off, uint3 input)
{
    if (input.x == 0 || input.y == 0) return 0.0f;
    return getLayer2(tex, layer, off, uint3(input.xy - 1, input.z));
}

float padLayerEven(Texture2D<float> tex, uint layer, uint4 off, uint2 xyMax, uint3 input)
{
    if (input.x == 0 || input.y == 0 || input.x > xyMax.x || input.y > xyMax.y) return 0.0f;
    return getLayer2(tex, layer, off, uint3(input.xy - 1, input.z));
}

float getConst(Texture2D<float> tex, uint index, uint2 off)
{
    return tex[weightsPos[index] + off];
}

float getConst(Texture2D<float> tex, uint index, uint4 off)
{
    uint2 pos;
    pos.x = off.w + off.z * 3 + off.y * 9;
    pos.y = off.x;
    return tex[weightsPos[index] + pos];
}

float getConst2x2(Texture2D<float> tex, uint index, uint4 off)
{
    uint2 pos;
    pos.x = off.w + off.z * 2 + off.y * 4;
    pos.y = off.x;
    return tex[weightsPos[index] + pos];
}

float getConst4x4(Texture2D<float> tex, uint index, uint4 off)
{
    uint2 pos;
    pos.x = off.w + off.z * 4 + off.y * 16;
    pos.y = off.x;
    return tex[weightsPos[index] + pos];
}

float getConst2(Texture2D<float> tex, uint index, uint4 off)
{
    uint2 pos;
    pos.x = off.w + off.z * 3 + (off.y % 64) * 9;
    pos.y = off.x * 4 + off.y / 64;
    return tex[weightsPos[index] + pos];
}

float getMeanVar(Texture2D<float> tex, uint index, uint off)
{
    return tex[weightsPos[index + 66] + uint2(off, 0)];
}

float getL1(Texture2D<float> tex, uint3 off)
{
    uint2 pos;
    pos.x = off.x + off.z * 512;
    pos.y = off.y;
    return tex[layerPos1[0] + pos];
}

float getIDs(Texture2D<float> tex, uint2 off)
{
    return tex[layerPos1[4] + off];
}

float getL3(Texture2D<float> tex, uint3 off)
{
    uint2 pos;
    pos.x = off.x + off.z * 512;
    pos.y = off.y;
    return tex[layerPos1[1] + pos];
}

float getL4(Texture2D<float> tex, uint2 off)
{
    return tex[layerPos1[2] + off];
}

float getL5(Texture2D<float> tex, uint2 off)
{
    return tex[layerPos1[3] + off];
}

float getL6(Texture2D<float> tex, uint4 off)
{
    uint2 pos;
    pos.x = off.x + off.z * layerPos1[4].z;
    pos.y = off.y + off.w * layerPos1[4].w;
    return tex[layerPos1[5] + pos];
}

#endif